{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}Users{% endblock %}

{% block extra_css %}
    {% include "includes/datatable_styles.html" %}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <!-- Add search and filter section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <form method="get" id="filterForm" class="d-flex gap-2">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control form-control-sm" 
                               placeholder="Search by name, email, phone..." value="{{ search|default:'' }}">
                        <button class="btn btn-outline-primary btn-sm" type="submit">
                            <i class="bx bx-search"></i>
                        </button>
                        {% if search or role_filter or status_filter %}
                        <a href="{% url 'users:user_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bx bx-x"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end gap-2">
                    <!-- Role filter -->
                    <select name="role" class="form-select form-select-sm w-auto filter-select" data-filter="role">
                        <option value="">All Roles</option>
                        {% for role_code, role_name in role_choices %}
                        <option value="{{ role_code }}" {% if role_filter == role_code %}selected{% endif %}>
                            {{ role_name }}
                        </option>
                        {% endfor %}
                    </select>
                    
                    <!-- Status filter -->
                    <select name="is_active" class="form-select form-select-sm w-auto filter-select" data-filter="status">
                        <option value="">All Status</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active Only</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive Only</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
                <h5 class="mb-0">Users</h5>
                <p class="text-muted mb-0 small">
                    Showing {{ users.count }} user{{ users.count|pluralize }}
                    {% if search %}for "{{ search }}"{% endif %}
                </p>
            </div>
            <a href="{% url 'users:user_create' %}" class="btn btn-primary btn-sm">
                <i class="bx bx-plus"></i> Add New
            </a>
        </div>
        
        <!-- Add loading spinner -->
        <div id="loadingSpinner" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="userTable" class="table table-striped table-bordered" data-datatable data-title="User List" data-export-columns="[0, 1, 2, 3, 4, 5, 6, 7]">
                <thead>
                    <tr>
                        <th>Avatar</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Verified</th>
                        <th>Staff</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if users %}
                    {% for user_obj in users %}
                    <tr id="user-row-{{ user_obj.pk }}">
                        <td>
                            {% if user_obj.avatar %}
                            <img src="{{ user_obj.avatar.url }}" alt="{{ user_obj.get_full_name }}" 
                                 class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                 style="width:40px;height:40px;font-size: 14px;">
                                {{ user_obj.first_name.0|default:"" }}{{ user_obj.last_name.0|default:"" }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {{ user_obj.get_full_name }}
                            {% if user_obj == request.user %}
                            <span class="badge bg-info ms-1">You</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {{ user_obj.email }}
                                {% if user_obj.is_superuser %}
                                <span class="badge bg-danger ms-1" title="Superuser">SU</span>
                                {% endif %}
                            </div>
                        </td>
                      
                        <td>
                            {% if user_obj.phone_number %}
                            <a href="tel:{{ user_obj.phone_number }}">{{ user_obj.phone_number }}</a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input status-toggle" type="checkbox" 
                                       data-user-id="{{ user_obj.pk }}" 
                                       data-user-email="{{ user_obj.email }}"
                                       data-user-name="{{ user_obj.get_full_name }}"
                                       {% if user_obj.is_active %}checked{% endif %}
                                       {% if user_obj == request.user %}disabled title="Cannot deactivate yourself"{% endif %}>
                                <span class="form-check-label small ms-1">
                                    {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input verification-toggle" type="checkbox" 
                                       data-user-id="{{ user_obj.pk }}"
                                       data-user-email="{{ user_obj.email }}"
                                       data-user-name="{{ user_obj.get_full_name }}"
                                       {% if user_obj.is_verified %}checked{% endif %}>
                                <span class="form-check-label small ms-1">
                                    {% if user_obj.is_verified %}Yes{% else %}No{% endif %}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input staff-toggle" type="checkbox" 
                                       data-user-id="{{ user_obj.pk }}"
                                       data-user-email="{{ user_obj.email }}"
                                       data-user-name="{{ user_obj.get_full_name }}"
                                       {% if user_obj.is_staff %}checked{% endif %}
                                       {% if user_obj == request.user %}disabled title="Cannot remove your own staff status"{% endif %}>
                                <span class="form-check-label small ms-1">
                                    {% if user_obj.is_staff %}Yes{% else %}No{% endif %}
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex order-actions">
                                <a href="{% url 'users:user_detail' user_obj.pk %}" class="ms-2" 
                                   title="View Details" data-bs-toggle="tooltip">
                                    <i class="bx bxs-show"></i>
                                </a>
                                <a href="{% url 'users:user_update' user_obj.pk %}" class="ms-2" 
                                   title="Edit" data-bs-toggle="tooltip">
                                    <i class="bx bxs-edit"></i>
                                </a>
                                <a href="#" class="ms-2 text-warning reset-password" 
                                   data-user-id="{{ user_obj.pk }}"
                                   data-user-email="{{ user_obj.email }}"
                                   data-user-name="{{ user_obj.get_full_name }}"
                                   title="Reset Password" data-bs-toggle="tooltip">
                                    <i class="bx bx-key"></i>
                                </a>
                                {% if user_obj != request.user %}
                                <a href="{% url 'users:user_delete' user_obj.pk %}" class="ms-2 text-danger" 
                                   title="Delete" data-bs-toggle="tooltip">
                                    <i class="bx bxs-trash"></i>
                                </a>
                                {% else %}
                                <span class="ms-2 text-muted" title="Cannot delete yourself" data-bs-toggle="tooltip">
                                    <i class="bx bxs-trash"></i>
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bx bx-user-x" style="font-size: 48px;"></i>
                                <p class="mt-2">No users found</p>
                                {% if search %}
                                <p class="small">Try a different search term</p>
                                {% else %}
                                <a href="{% url 'users:user_create' %}" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="bx bx-plus"></i> Add First User
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Add pagination if not using DataTables -->
        {% if is_paginated and not request.GET.search %}
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center pagination-sm">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&is_active={{ status_filter }}{% endif %}">
                        Previous
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&is_active={{ status_filter }}{% endif %}">
                        {{ num }}
                    </a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&is_active={{ status_filter }}{% endif %}">
                        Next
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Add confirmation modal for actions -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="actionModalBody">
                <!-- Content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {% include "includes/datatable_scripts.html" %}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
        
        // Function to get CSRF token
        function getCSRFToken() {
            const csrfToken = $('meta[name="csrf-token"]').attr('content') || 
                             $('input[name="csrfmiddlewaretoken"]').val() ||
                             getCookie('csrftoken');
            return csrfToken;
        }
    
        // Helper function to get cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // Safe toastr wrapper
        const Toast = {
            success: function(msg) {
                if (typeof toastr !== 'undefined') toastr.success(msg);
                else alert(msg);
            },
            error: function(msg) {
                if (typeof toastr !== 'undefined') toastr.error(msg);
                else alert(msg);
            },
            info: function(msg) {
                if (typeof toastr !== 'undefined') toastr.info(msg);
                else console.log(msg);
            }
        };

        // Show loading spinner
        function showLoading() {
            $('#loadingSpinner').removeClass('d-none').addClass('d-block');
        }
    
        // Hide loading spinner
        function hideLoading() {
            $('#loadingSpinner').removeClass('d-block').addClass('d-none');
        }
    
        // Generic AJAX error handler
        function handleAjaxError(xhr, errorMessage) {
            console.error('AJAX Error:', errorMessage);
            let msg = 'An error occurred. Please try again.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            Toast.error(msg);
        }
    
        // Filter form submission
        $('.filter-select').on('change', function() {
            $('#filterForm').submit();
        });
    
        // Track if modal action was confirmed
        let modalActionConfirmed = false;
        let currentToggleElement = null;
        let currentToggleOriginalState = null;
    
        // Status toggle with confirmation
        $(document).on('change', '.status-toggle', function() {
            const $checkbox = $(this);
            const userId = $checkbox.data('user-id');
            const userEmail = $checkbox.data('user-email');
            const userName = $checkbox.data('user-name');
            const isChecked = $checkbox.prop('checked');
            const action = isChecked ? 'activate' : 'deactivate';
            
            // Store current toggle info for cancellation
            currentToggleElement = $checkbox;
            currentToggleOriginalState = !isChecked;
            modalActionConfirmed = false;
            
            // Show confirmation modal
            $('#actionModalBody').html(`
                <p>Are you sure you want to ${action} the user <strong>${userName}</strong> (${userEmail})?</p>
                ${!isChecked ? '<p class="text-warning"><small>The user will not be able to login.</small></p>' : ''}
            `);
            
            $('#actionModal').modal('show');
            
            $('#confirmAction').off('click').on('click', function() {
                modalActionConfirmed = true;
                $('#actionModal').modal('hide');
                
                showLoading(); // Show before starting
                $checkbox.prop('disabled', true);

                $.ajax({
                    url: `/users/${userId}/toggle-status/`,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            Toast.success(response.message);
                            // Update the label text
                            $checkbox.next('.form-check-label').text(response.is_active ? 'Active' : 'Inactive');
                        } else {
                            Toast.error(response.message || 'Failed to update status');
                            $checkbox.prop('checked', !isChecked);
                        }
                    },
                    error: function(xhr, status, error) {
                        handleAjaxError(xhr, error);
                        $checkbox.prop('checked', !isChecked);
                    },
                    complete: function() {
                        hideLoading();
                        $checkbox.prop('disabled', false);
                    }
                });
            });
        });
    
        // Verification toggle
        $(document).on('change', '.verification-toggle', function() {
            const $checkbox = $(this);
            const userId = $checkbox.data('user-id');
            const userEmail = $checkbox.data('user-email');
            const userName = $checkbox.data('user-name');
            const isChecked = $checkbox.prop('checked');
            
            showLoading();
            $checkbox.prop('disabled', true);

            $.ajax({
              url: `/users/${userId}/toggle-verification/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        Toast.success(response.message);
                        $checkbox.next('.form-check-label').text(response.is_verified ? 'Yes' : 'No');
                    } else {
                        Toast.error(response.message || 'Failed to update verification');
                        $checkbox.prop('checked', !isChecked);
                    }
                },
                error: function(xhr, status, error) {
                    handleAjaxError(xhr, error);
                    $checkbox.prop('checked', !isChecked);
                },
                complete: function() {
                    hideLoading();
                    $checkbox.prop('disabled', false);
                }
            });
        });
    
        // Staff toggle with confirmation
        $(document).on('change', '.staff-toggle', function() {
            const $checkbox = $(this);
            const userId = $checkbox.data('user-id');
            const userEmail = $checkbox.data('user-email');
            const userName = $checkbox.data('user-name');
            const isChecked = $checkbox.prop('checked');
            const action = isChecked ? 'grant staff privileges to' : 'revoke staff privileges from';
            
            // Store current toggle info for cancellation
            currentToggleElement = $checkbox;
            currentToggleOriginalState = !isChecked;
            modalActionConfirmed = false;
            
            // Show confirmation modal for staff changes
            $('#actionModalBody').html(`
                <p>Are you sure you want to ${action} <strong>${userName}</strong>?</p>
                ${isChecked ? 
                    '<p class="text-info"><small>Staff members have access to admin features.</small></p>' : 
                    '<p class="text-warning"><small>This user will lose access to admin features.</small></p>'
                }
            `);
            
            $('#actionModal').modal('show');
            
            $('#confirmAction').off('click').on('click', function() {
                modalActionConfirmed = true;
                $('#actionModal').modal('hide');
                
                showLoading();
                $checkbox.prop('disabled', true);

                $.ajax({
                   url: `/users/${userId}/toggle-staff/`,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            Toast.success(response.message);
                            $checkbox.next('.form-check-label').text(response.is_staff ? 'Yes' : 'No');
                        } else {
                            Toast.error(response.message || 'Failed to update staff status');
                            $checkbox.prop('checked', !isChecked);
                        }
                    },
                    error: function(xhr, status, error) {
                        handleAjaxError(xhr, error);
                        $checkbox.prop('checked', !isChecked);
                    },
                    complete: function() {
                        hideLoading();
                        $checkbox.prop('disabled', false);
                    }
                });
            });
        });
    
        // Role change
        $(document).on('change', '.role-select', function() {
            const $select = $(this);
            const userId = $select.data('user-id');
            const newRole = $select.val();
            const previousValue = $select.data('previous-value') || $select.val();
            
            showLoading();
            $select.prop('disabled', true);

            $.ajax({
                 url: `/users/${userId}/change-role/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'role': newRole
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        Toast.success(response.message);
                        $select.data('previous-value', newRole);
                    } else {
                        Toast.error(response.message || 'Failed to update role');
                        $select.val(previousValue);
                    }
                },
                error: function(xhr, status, error) {
                    handleAjaxError(xhr, error);
                    $select.val(previousValue);
                },
                complete: function() {
                    hideLoading();
                    $select.prop('disabled', false);
                }
            });
        });
    
        // Store original value when select gets focus
        $(document).on('focus', '.role-select', function() {
            $(this).data('previous-value', $(this).val());
        });
    
        // Reset password with enhanced confirmation
        $(document).on('click', '.reset-password', function(e) {
            e.preventDefault();
            const $link = $(this);
            const userId = $link.data('user-id');
            const userEmail = $link.data('user-email');
            const userName = $link.data('user-name');
            
            // Show confirmation modal
            $('#actionModalBody').html(`
                <p>Reset password for <strong>${userName}</strong> (${userEmail})?</p>
                <p class="text-warning"><small>The user will receive a new randomly generated password.</small></p>
                <div class="alert alert-info">
                    <i class="bx bx-info-circle"></i>
                    <small>Make sure to save the new password securely as you will only see it once.</small>
                </div>
            `);
            
            $('#actionModal').modal('show');
            
            $('#confirmAction').off('click').on('click', function() {
                $('#actionModal').modal('hide');
                
                showLoading();
                $link.prop('disabled', true);

                $.ajax({
                    url: `/users/${userId}/reset-password/`,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            Toast.success(response.message);
                            // Show password in a more user-friendly way
                            const passwordModal = `
                                <div class="modal fade" id="passwordModal" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Password Reset Successful</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Password has been reset for <strong>${userName}</strong>.</p>
                                                <div class="alert alert-warning">
                                                    <h6>New Password:</h6>
                                                    <div class="input-group mb-2">
                                                        <input type="text" class="form-control" id="newPassword" 
                                                               value="${response.new_password}" readonly>
                                                        <button class="btn btn-outline-secondary" type="button" 
                                                                onclick="copyPassword()">
                                                            <i class="bx bx-copy"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-danger">
                                                        <i class="bx bx-error"></i>
                                                        Store this password securely. You won't be able to see it again.
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                                    I've Saved the Password
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            $('body').append(passwordModal);
                            $('#passwordModal').modal('show');
                            
                            // Copy function
                            window.copyPassword = function() {
                                const copyText = document.getElementById("newPassword");
                                copyText.select();
                                copyText.setSelectionRange(0, 99999);
                                document.execCommand("copy");
                                Toast.info("Password copied to clipboard");
                            };
                            
                            // Remove modal from DOM when hidden
                            $('#passwordModal').on('hidden.bs.modal', function () {
                                $(this).remove();
                            });
                        } else {
                            Toast.error(response.message || 'Failed to reset password');
                        }
                    },
                    error: function(xhr, status, error) {
                        handleAjaxError(xhr, error);
                    },
                    complete: function() {
                        hideLoading();
                        $link.prop('disabled', false);
                    }
                });
            });
        });
    
        // Handle modal cancellation - only revert if not confirmed
        $('#actionModal').on('hidden.bs.modal', function() {
            // Only revert checkbox if action was NOT confirmed
            if (!modalActionConfirmed && currentToggleElement) {
                currentToggleElement.prop('checked', currentToggleOriginalState);
            }
            // Reset tracking variables
            currentToggleElement = null;
            currentToggleOriginalState = null;
            modalActionConfirmed = false;
        });
    });
    </script>
{% endblock %}