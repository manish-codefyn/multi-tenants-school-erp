{% extends 'layouts/dashboard.html' %}
{% load static %}

{% block title %}Institute Dashboard - EduERP{% endblock %}

{% block content %}

        <!-- Statistics Cards -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
            <div class="col">
                <div class="card radius-10 bg-gradient-cosmic">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-auto">
                                <p class="mb-0 text-white">Total Students</p>
                                <h4 class="my-1 text-white">{{ total_students|default:"0" }}</h4>
                                <p class="mb-0 font-13 text-white"><i class="bx bx-up-arrow-alt"></i> +5.2% from last month</p>
                            </div>
                            <div id="chart-students"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card radius-10 bg-gradient-ibiza">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-auto">
                                <p class="mb-0 text-white">Total Teachers</p>
                                <h4 class="my-1 text-white">{{ total_teachers|default:"0" }}</h4>
                                <p class="mb-0 font-13 text-white"><i class="bx bx-up-arrow-alt"></i> +2.1% from last month</p>
                            </div>
                            <div id="chart-teachers"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card radius-10 bg-gradient-ohhappiness">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-auto">
                                <p class="mb-0 text-white">Attendance Rate</p>
                                <h4 class="my-1 text-white">87.5%</h4>
                                <p class="mb-0 font-13 text-white"><i class="bx bx-down-arrow-alt"></i> -1.2% from last week</p>
                            </div>
                            <div id="chart-attendance"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card radius-10 bg-gradient-kyoto">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-auto">
                                <p class="mb-0 text-dark">Departments</p>
                                <h4 class="my-1 text-dark">{{ departments.count|default:"0" }}</h4>
                                <p class="mb-0 font-13 text-dark">Active departments</p>
                            </div>
                            <div class="text-dark">
                                <i class="bx bxs-buildings fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--end row-->

        <!-- Charts Row -->
        <div class="row mt-3">
            <div class="col-12 col-lg-8">
                <div class="card radius-10">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Student Enrollment Overview</h6>
                            </div>
                            <div class="dropdown ms-auto">
                                <a class="dropdown-toggle dropdown-toggle-nocaret" href="#" data-bs-toggle="dropdown">
                                    <i class='bx bx-dots-horizontal-rounded font-22 text-option'></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="javascript:;">This Month</a></li>
                                    <li><a class="dropdown-item" href="javascript:;">This Year</a></li>
                                    <li><a class="dropdown-item" href="javascript:;">All Time</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center ms-auto font-13 gap-2 mb-3">
                            <span class="border px-2 rounded cursor-pointer"><i class="bx bxs-circle me-1 text-primary"></i>New Admissions</span>
                            <span class="border px-2 rounded cursor-pointer"><i class="bx bxs-circle me-1 text-success"></i>Active Students</span>
                        </div>
                        <div class="chart-container-1">
                            <canvas id="enrollmentChart"></canvas>
                        </div>
                    </div>
                    <div class="row row-cols-1 row-cols-md-3 g-0 row-group text-center border-top">
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0">{{ total_students|default:"0" }}</h5>
                                <small class="mb-0">Total Students <span class="text-success"><i class="bx bx-up-arrow-alt align-middle"></i> 5.2%</span></small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0">156</h5>
                                <small class="mb-0">This Month <span class="text-success"><i class="bx bx-up-arrow-alt align-middle"></i> 12.5%</span></small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0">98.2%</h5>
                                <small class="mb-0">Retention Rate <span class="text-success"><i class="bx bx-up-arrow-alt align-middle"></i> 2.1%</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card radius-10">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Department Distribution</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-2">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center border-top">
                            Computer Science <span class="badge bg-primary rounded-pill">450</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Engineering <span class="badge bg-success rounded-pill">380</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Business <span class="badge bg-warning rounded-pill">320</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div><!--end row-->

        <!-- Role-Specific Financial Widget -->
        {% if show_financial_data %}
        <div class="row mt-3">
            <div class="col-12 col-lg-8">
                <div class="card radius-10">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Financial Overview</h6>
                            </div>
                            <div class="dropdown ms-auto">
                                <a class="dropdown-toggle dropdown-toggle-nocaret" href="#" data-bs-toggle="dropdown">
                                    <i class='bx bx-dots-horizontal-rounded font-22 text-option'></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="javascript:;">Monthly</a></li>
                                    <li><a class="dropdown-item" href="javascript:;">Quarterly</a></li>
                                    <li><a class="dropdown-item" href="javascript:;">Yearly</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-1">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="row row-cols-1 row-cols-md-3 g-0 row-group text-center border-top">
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0 text-success">₹12.5L</h5>
                                <small class="mb-0">Total Revenue</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0 text-primary">₹11.75L</h5>
                                <small class="mb-0">Collected</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="p-3">
                                <h5 class="mb-0 text-warning">₹75K</h5>
                                <small class="mb-0">Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card radius-10">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Fee Collection Rate</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-2">
                            <canvas id="collectionChart"></canvas>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <h4 class="mb-0 text-success">94.0%</h4>
                        <p class="mb-0 text-muted">Collection Efficiency</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Performance Metrics -->
        <div class="row mt-3">
            <div class="col-12 col-lg-4 d-flex">
                <div class="card radius-10 w-100">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Attendance Trends</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-2">
                            <canvas id="attendanceTrendChart"></canvas>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center border-top">
                            Present <span class="badge bg-success rounded-pill">87.5%</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Absent <span class="badge bg-danger rounded-pill">8.2%</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Late <span class="badge bg-warning rounded-pill">4.3%</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-12 col-lg-4 d-flex">
                <div class="card radius-10 w-100">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Exam Performance</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-2">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center border-top">
                            Pass Rate <span class="badge bg-success rounded-pill">92.3%</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Average Score <span class="badge bg-primary rounded-pill">78.5</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Top Score <span class="badge bg-warning rounded-pill">98.5</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-12 col-lg-4 d-flex">
                <div class="card radius-10 w-100">
                    <div class="card-header bg-transparent">
                        <div class="d-flex align-items-center">
                            <div>
                                <h6 class="mb-0">Library Activity</h6>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-2">
                            <canvas id="libraryChart"></canvas>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center border-top">
                            Total Books <span class="badge bg-primary rounded-pill">10,000</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Issued <span class="badge bg-success rounded-pill">1,250</span>
                        </li>
                        <li class="list-group-item d-flex bg-transparent justify-content-between align-items-center">
                            Overdue <span class="badge bg-danger rounded-pill">45</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div><!--end row-->

        <!-- Quick Actions -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card radius-10">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3">
                            {% if show_student_management %}
                            <div class="col">
                                <a href="{% url 'academics:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-graduation fs-1 text-primary"></i>
                                        <p class="mb-0 mt-2 small">Academics</p>
                                    </div>
                                </a>
                            </div>
                            <div class="col">
                                <a href="{% url 'attendance:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-calendar-check fs-1 text-success"></i>
                                        <p class="mb-0 mt-2 small">Attendance</p>
                                    </div>
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if show_financial_data %}
                            <div class="col">
                                <a href="{% url 'fees:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-wallet fs-1 text-warning"></i>
                                        <p class="mb-0 mt-2 small">Fees</p>
                                    </div>
                                </a>
                            </div>
                            {% endif %}
                            
                            <div class="col">
                                <a href="{% url 'exams:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-edit fs-1 text-info"></i>
                                        <p class="mb-0 mt-2 small">Exams</p>
                                    </div>
                                </a>
                            </div>
                            
                            <div class="col">
                                <a href="{% url 'library:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-book fs-1 text-danger"></i>
                                        <p class="mb-0 mt-2 small">Library</p>
                                    </div>
                                </a>
                            </div>
                            
                            <div class="col">
                                <a href="{% url 'communication:dashboard' %}" class="text-decoration-none">
                                    <div class="p-3 border rounded text-center hover-shadow">
                                        <i class="bx bxs-message-dots fs-1 text-secondary"></i>
                                        <p class="mb-0 mt-2 small">Communication</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Academic Year -->
        {% if current_academic_year %}
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-primary border-0 bg-gradient-cosmic">
                    <div class="d-flex align-items-center">
                        <div class="text-white">
                            <i class="bx bx-calendar fs-3"></i>
                        </div>
                        <div class="ms-3 text-white">
                            <strong>Current Academic Year:</strong> {{ current_academic_year.name }} 
                            <span class="ms-2">({{ current_academic_year.start_date|date:"M d, Y" }} - {{ current_academic_year.end_date|date:"M d, Y" }})</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

{% endblock %}

{% block extra_css %}
<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
}
.chart-container-1 {
    position: relative;
    height: 300px;
}
.chart-container-2 {
    position: relative;
    height: 250px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
$(document).ready(function() {
    
    // Mini Sparkline Charts for Stats Cards
    var sparklineOptions = {
        chart: {
            type: 'line',
            width: 100,
            height: 50,
            sparkline: { enabled: true }
        },
        stroke: { width: 2, curve: 'smooth' },
        colors: ['#fff'],
        tooltip: { enabled: false }
    };

    new ApexCharts(document.querySelector("#chart-students"), {
        ...sparklineOptions,
        series: [{data: [25, 66, 41, 59, 25, 44, 12, 36, 9, 21]}]
    }).render();

    new ApexCharts(document.querySelector("#chart-teachers"), {
        ...sparklineOptions,
        series: [{data: [12, 14, 2, 47, 32, 44, 14, 55, 41, 69]}]
    }).render();

    new ApexCharts(document.querySelector("#chart-attendance"), {
        ...sparklineOptions,
        series: [{data: [47, 45, 74, 32, 56, 31, 44, 33, 45, 19]}]
    }).render();

    // Enrollment Chart (Line Chart)
    const enrollmentCtx = document.getElementById('enrollmentChart');
    if (enrollmentCtx) {
        new Chart(enrollmentCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'New Admissions',
                    data: [65, 59, 80, 81, 56, 55, 70, 85, 92, 78, 88, 95],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Active Students',
                    data: [850, 905, 980, 1055, 1105, 1155, 1220, 1300, 1385, 1458, 1540, 1630],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Department Distribution (Doughnut Chart)
    const deptCtx = document.getElementById('departmentChart');
    if (deptCtx) {
        new Chart(deptCtx, {
            type: 'doughnut',
            data: {
                labels: ['Computer Science', 'Engineering', 'Business', 'Arts', 'Science'],
                datasets: [{
                    data: [450, 380, 320, 280, 240],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Revenue Chart (Bar Chart)
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Revenue (₹ Lakhs)',
                    data: [8.5, 9.2, 10.5, 11.2, 10.8, 12.5, 13.2, 11.8, 12.0, 13.5, 14.2, 15.0],
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Collection Rate (Gauge/Doughnut)
    const collectionCtx = document.getElementById('collectionChart');
    if (collectionCtx) {
        new Chart(collectionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Collected', 'Pending'],
                datasets: [{
                    data: [94, 6],
                    backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.3)'],
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Attendance Trend (Line Chart)
    const attendanceCtx = document.getElementById('attendanceTrendChart');
    if (attendanceCtx) {
        new Chart(attendanceCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                datasets: [{
                    label: 'Attendance %',
                    data: [88, 85, 90, 87, 86, 84],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    // Performance Chart (Radar)
    const performanceCtx = document.getElementById('performanceChart');
    if (performanceCtx) {
        new Chart(performanceCtx, {
            type: 'radar',
            data: {
                labels: ['Math', 'Science', 'English', 'History', 'Arts'],
                datasets: [{
                    label: 'Average Score',
                    data: [85, 78, 82, 75, 88],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    r: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    // Library Activity (Bar Chart)
    const libraryCtx = document.getElementById('libraryChart');
    if (libraryCtx) {
        new Chart(libraryCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                datasets: [{
                    label: 'Books Issued',
                    data: [45, 52, 48, 55, 60, 35],
                    backgroundColor: 'rgba(153, 102, 255, 0.6)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
});
</script>
{% endblock %}
