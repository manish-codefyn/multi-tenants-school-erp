{% extends 'layouts/dashboard.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Bulk Mark Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <!-- Header & Stats -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="fw-bold text-primary mb-1">Mark Attendance</h4>
                <p class="text-muted small mb-0">Select class and marking method</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'attendance:student_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bx bx-arrow-back me-1"></i> Back to List
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form method="post" id="attendanceForm">
                    {% csrf_token %}
                    {{ form.attendance_data }} <!-- Hidden field for JSON data -->
                    
                    <!-- Filters Row -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            {{ form.date|as_crispy_field }}
                        </div>
                        <div class="col-md-3">
                            {{ form.class_name|as_crispy_field }}
                        </div>
                        <div class="col-md-3">
                            {{ form.section|as_crispy_field }}
                        </div>
                        <div class="col-md-3 d-flex align-items-end mb-3">
                            <button type="button" class="btn btn-primary w-100" id="btnLoadStudents" onclick="loadStudents()">
                                <i class="bx bx-check-circle me-1"></i> Load Students
                            </button>
                        </div>
                    </div>

                    <!-- TABS for Marking Modes -->
                    <ul class="nav nav-pills mb-3" id="markingTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="pill" data-bs-target="#manual" type="button" role="tab" aria-controls="manual" aria-selected="true">
                                <i class="bx bx-edit me-1"></i> Manual Mark
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="qr-tab" data-bs-toggle="pill" data-bs-target="#qr" type="button" role="tab" aria-controls="qr" aria-selected="false">
                                <i class="bx bx-qr-scan me-1"></i> QR Scan
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="face-tab" data-bs-toggle="pill" data-bs-target="#face" type="button" role="tab" aria-controls="face" aria-selected="false">
                                <i class="bx bx-face me-1"></i> Face Rec (Beta)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="markingTabsContent">
                        
                        <!-- TAB 1: MANUAL MARKING -->
                        <div class="tab-pane fade show active" id="manual" role="tabpanel" aria-labelledby="manual-tab">
                            
                            <!-- Controls: Grid/List Toggle & Bulk Actions -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary active" id="btnListView" onclick="setManualView('list')">
                                        <i class="bx bx-list-ul"></i> List
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="btnGridView" onclick="setManualView('grid')">
                                        <i class="bx bx-grid-alt"></i> Grid
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success" onclick="markAll('PRESENT')">Mark All Present</button>
                                    <button type="button" class="btn btn-outline-danger" onclick="markAll('ABSENT')">Mark All Absent</button>
                                </div>
                            </div>

                            <!-- Students Container -->
                            <div id="studentsContainer" class="position-relative min-vh-50">
                                <div id="loadingSpinner" class="text-center py-5 d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Fetching students...</p>
                                </div>
                                
                                <div id="emptyState" class="text-center py-5">
                                    <i class="bx bx-user-pin fs-1 text-muted opacity-50"></i>
                                    <p class="mt-2 text-muted">Select Class and Section to load students.</p>
                                </div>

                                <!-- List View Table -->
                                <div id="manualListView" class="d-none">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th>Rank/ID</th>
                                                    <th>Student</th>
                                                    <th class="text-center">Status</th>
                                                    <th>Remarks</th>
                                                </tr>
                                            </thead>
                                            <tbody id="studentTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Grid View Cards -->
                                <div id="manualGridView" class="d-none">
                                    <div class="row g-3" id="studentGridBody"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: QR SCANNER -->
                        <div class="tab-pane fade" id="qr" role="tabpanel" aria-labelledby="qr-tab">
                            <div class="row justify-content-center">
                                <div class="col-md-6 text-center">
                                    <div id="qr-reader" style="width: 100%; min-height: 300px; background: #000; overflow: hidden; border-radius: 8px;"></div>
                                    <p class="text-muted mt-3 small">Use camera to scan student ID cards. Ensure proper lighting.</p>
                                    <div id="qr-result" class="alert alert-secondary mt-2 d-none"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="fw-bold">Scanned Students</h6>
                                    <ul class="list-group list-group-flush border rounded" id="scannedList" style="max-height: 400px; overflow-y: auto;">
                                        <li class="list-group-item text-muted text-center small">No scans yet</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 3: FACE RECOGNITION (EXPERIMENTAL) -->
                        <div class="tab-pane fade" id="face" role="tabpanel" aria-labelledby="face-tab">
                            <div class="row justify-content-center">
                                <div class="col-md-8 text-center">
                                    <div class="position-relative d-inline-block rounded overflow-hidden bg-dark" style="min-width: 400px; min-height: 300px;">
                                        <video id="faceVideo" width="640" height="480" autoplay muted style="width: 100%; height: auto;"></video>
                                        <canvas id="faceCanvas" class="position-absolute top-0 start-0 w-100 h-100"></canvas>
                                    </div>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-primary" onclick="startFaceRec()">
                                            <i class="bx bx-play"></i> Start Camera
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="stopFaceRec()">
                                            <i class="bx bx-stop"></i> Stop
                                        </button>
                                    </div>
                                    <div class="alert alert-warning mt-3">
                                        <i class="bx bx-info-circle"></i> This feature is experimental and relies on browser capabilities.
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Footer Actions -->
                    <div class="border-top pt-4 mt-4 d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Total Students: <span id="totalCount">0</span> | Present: <span id="presentCount">0</span>
                        </div>
                        <button type="submit" class="btn btn-primary px-4 shadow-sm">
                            <i class="bx bx-save me-1"></i> Save Attendance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- EXTERNAL LIBS -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<!-- Face API (Example CDN, check availability or host properly) -->
<!-- <script defer src="https://cdn.jsdelivr.net/npm/face-api.js/dist/face-api.min.js"></script> -->

<script>
let allStudents = [];
let attendanceState = {}; // Key: studentId, Value: STATUS

function setManualView(mode) {
    const listDiv = document.getElementById('manualListView');
    const gridDiv = document.getElementById('manualGridView');
    const btnList = document.getElementById('btnListView');
    const btnGrid = document.getElementById('btnGridView');

    if (mode === 'grid') {
        listDiv.classList.add('d-none');
        gridDiv.classList.remove('d-none');
        btnList.classList.remove('active');
        btnGrid.classList.add('active');
    } else {
        gridDiv.classList.add('d-none');
        listDiv.classList.remove('d-none');
        btnGrid.classList.remove('active');
        btnList.classList.add('active');
    }
}

function loadStudents() {
    const classId = document.getElementById('id_class_name').value;
    const sectionId = document.getElementById('id_section').value;
    
    if(!classId || !sectionId) {
        alert('Please select Class and Section first.');
        return;
    }

    // Show loading
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('emptyState').classList.add('d-none');
    document.getElementById('studentsContainer').classList.remove('d-none');
    document.getElementById('studentTableBody').innerHTML = '';
    document.getElementById('studentGridBody').innerHTML = '';

    fetch(`{% url 'attendance:api_get_students' %}?class_id=${classId}&section_id=${sectionId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSpinner').classList.add('d-none');
            
            if(data.students && data.students.length > 0) {
                allStudents = data.students;
                renderStudents();
            } else {
                document.getElementById('emptyState').innerHTML = '<p class="text-muted">No students found in this class.</p>';
                document.getElementById('emptyState').classList.remove('d-none');
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('loadingSpinner').classList.add('d-none');
            alert('Error loading students');
        });
}

function renderStudents() {
    const tableBody = document.getElementById('studentTableBody');
    const gridBody = document.getElementById('studentGridBody');
    tableBody.innerHTML = '';
    gridBody.innerHTML = '';

    allStudents.forEach(student => {
        // Init state if not set
        if(!attendanceState[student.id]) attendanceState[student.id] = 'PRESENT';
        
        // 1. Render Table Row
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="badge bg-light text-dark border">${student.roll_number || '-'}</span></td>
            <td>
                <div class="d-flex align-items-center">
                    ${student.image_url 
                        ? `<img src="${student.image_url}" class="rounded-circle me-2" width="32" height="32">`
                        : `<div class="avatar avatar-xs rounded-circle bg-secondary-subtle me-2 d-flex align-items-center justify-content-center text-secondary font-monospace " style="width:32px;height:32px">${student.name.substring(0,2).toUpperCase()}</div>`
                    }
                    <div>
                        <div class="fw-bold fs-6">${student.name}</div>
                        <div class="small text-muted">${student.admission_number}</div>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="status_${student.id}" id="p_${student.id}" value="PRESENT" ${attendanceState[student.id] === 'PRESENT' ? 'checked' : ''} onchange="updateStatus(${student.id}, 'PRESENT')">
                    <label class="btn btn-outline-success" for="p_${student.id}">P</label>

                    <input type="radio" class="btn-check" name="status_${student.id}" id="a_${student.id}" value="ABSENT" ${attendanceState[student.id] === 'ABSENT' ? 'checked' : ''} onchange="updateStatus(${student.id}, 'ABSENT')">
                    <label class="btn btn-outline-danger" for="a_${student.id}">A</label>

                    <input type="radio" class="btn-check" name="status_${student.id}" id="l_${student.id}" value="LATE" ${attendanceState[student.id] === 'LATE' ? 'checked' : ''} onchange="updateStatus(${student.id}, 'LATE')">
                    <label class="btn btn-outline-warning" for="l_${student.id}">L</label>
                </div>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm border-0 bg-light" placeholder="Remarks..." onchange="updateRemarks(${student.id}, this.value)">
            </td>
        `;
        tableBody.appendChild(tr);

        // 2. Render Grid Card
        const col = document.createElement('div');
        col.className = 'col-xl-3 col-md-4 col-sm-6';
        col.innerHTML = `
            <div class="card h-100 text-center border shadow-sm status-card-${student.id}">
                <div class="card-body">
                    <div class="mb-3">
                         ${student.image_url 
                        ? `<img src="${student.image_url}" class="rounded-circle shadow-sm" width="80" height="80" style="object-fit:cover;">`
                        : `<div class="avatar avatar-xl rounded-circle bg-secondary-subtle mx-auto d-flex align-items-center justify-content-center text-secondary fs-2 fw-bold" style="width:80px;height:80px">${student.name.substring(0,2).toUpperCase()}</div>`
                        }
                    </div>
                    <h6 class="card-title fw-bold mb-1">${student.name}</h6>
                    <p class="text-muted small mb-3">Roll: ${student.roll_number || 'N/A'}</p>
                    
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-success ${attendanceState[student.id] === 'PRESENT' ? 'active' : ''}" onclick="updateStatus(${student.id}, 'PRESENT')">P</button>
                        <button type="button" class="btn btn-sm btn-outline-danger ${attendanceState[student.id] === 'ABSENT' ? 'active' : ''}" onclick="updateStatus(${student.id}, 'ABSENT')">A</button>
                        <button type="button" class="btn btn-sm btn-outline-warning ${attendanceState[student.id] === 'LATE' ? 'active' : ''}" onclick="updateStatus(${student.id}, 'LATE')">L</button>
                    </div>
                </div>
            </div>
        `;
        gridBody.appendChild(col);
    });

    updateSummary();
}

function updateStatus(studentId, status) {
    attendanceState[studentId] = status;
    
    // Sync UI (Checkbox/Radio)
    const radio = document.getElementById(status.toLowerCase()[0] + '_' + studentId);
    if(radio) radio.checked = true;

    // Re-render specifically this card/row would be efficient, but simple re-render is safer for syncing Grid/List
    // For performance, we could just toggle classes, but let's just update the hidden JSON for now
    updateHiddenJson();
    updateSummary();
    
    // Visual feedback for Grid View
    // (Optional: add green/red border to card)
}

function markAll(status) {
    allStudents.forEach(student => {
        updateStatus(student.id, status);
    });
    renderStudents(); // Refresh UI to show all checked
}

function updateSummary() {
    document.getElementById('totalCount').innerText = allStudents.length;
    const present = Object.values(attendanceState).filter(s => s === 'PRESENT').length;
    document.getElementById('presentCount').innerText = present;
}

function updateHiddenJson() {
    const jsonField = document.querySelector('input[name="attendance_data"]'); // It's hidden
    if(jsonField) {
        jsonField.value = JSON.stringify(attendanceState);
    }
}

// Hook into form submit to ensure latest data
document.getElementById('attendanceForm').addEventListener('submit', function() {
    updateHiddenJson();
});

/* ================= QR CODE LOGIC ================= */
let html5QrcodeScanner = null;

document.getElementById('qr-tab').addEventListener('shown.bs.tab', function (e) {
     if(!html5QrcodeScanner) {
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            console.error("Error starting QR scanner", err);
        });
     }
});

function onScanSuccess(decodedText, decodedResult) {
    // Scan logic: Assuming QR contains "roll_number" or "admission_number"
    const student = allStudents.find(s => s.roll_number === decodedText || s.admission_number === decodedText);
    
    if (student) {
        updateStatus(student.id, 'PRESENT');
        renderStudents(); // Update UI
        
        // Add to scanned list
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center text-success';
        li.innerHTML = `${student.name} <i class="bx bx-check-circle"></i>`;
        const list = document.getElementById('scannedList');
        if(list.children[0].innerText === 'No scans yet') list.innerHTML = '';
        list.prepend(li);
        
        // Feedback
        const resultDiv = document.getElementById('qr-result');
        resultDiv.classList.remove('d-none', 'alert-danger');
        resultDiv.classList.add('alert-success');
        resultDiv.innerText = `Marked Present: ${student.name}`;
    } else {
        const resultDiv = document.getElementById('qr-result');
        resultDiv.classList.remove('d-none', 'alert-success');
        resultDiv.classList.add('alert-danger');
        resultDiv.innerText = `Student not found for QR: ${decodedText}`;
    }
}

function onScanFailure(error) {
    // Handle scan failure, usually better to ignore frame errors
}

/* ================= FACE REC LOGIC (Stub) ================= */
let videoStream = null;
function startFaceRec() {
    const video = document.getElementById('faceVideo');
    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                videoStream = stream;
                video.srcObject = stream;
            })
            .catch(function (error) {
                console.log("Something went wrong with camera!", error);
            });
    }
}

function stopFaceRec() {
    if(videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        document.getElementById('faceVideo').srcObject = null;
    }
}

// Initial Call
document.addEventListener('DOMContentLoaded', function() {
    setManualView('list');
});
</script>
{% endblock %}
